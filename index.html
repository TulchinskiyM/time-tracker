<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker — Harvest‑style</title>
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --panel:#111827;        /* gray-900 */
      --panel-2:#0b1222;      /* deep */
      --muted:#94a3b8;        /* slate-400 */
      --text:#e5e7eb;         /* gray-200 */
      --accent:#3b82f6;       /* blue-500 */
      --accent-2:#2563eb;     /* blue-600 */
      --ok:#10b981;           /* emerald-500 */
      --warn:#f59e0b;         /* amber-500 */
      --danger:#ef4444;       /* red-500 */
      --card:#0b1222;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(90% 100% at 10% 0%, #111827, #0a0f1e 60%, #060b18 100%);
      color:var(--text); font: 500 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    a{color:var(--accent)}
    .container{max-width:1100px; margin:24px auto; padding:0 16px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px; height:42px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--ok));
      display:grid; place-items:center; color:white; font-weight:800; box-shadow:var(--shadow)
    }
    .title{font-weight:800; letter-spacing:.3px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.008)); border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:20px}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns: 1.1fr .9fr}
    @media (max-width: 900px){ .grid-2{grid-template-columns: 1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, textarea, select{
      width:100%; background:#0b1020; color:var(--text); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:10px 12px; outline:none; transition:.2s border;
    }
    input:focus, textarea:focus{border-color: var(--accent)}
    textarea{min-height:72px; resize:vertical}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}

    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer;
      background: var(--accent); color:white; box-shadow:var(--shadow); transition: transform .05s ease, background .2s ease, opacity .2s ease;
    }
    .btn:hover{background: var(--accent-2)}
    .btn:active{transform: translateY(1px)}
    .btn.secondary{ background: transparent; border:1px solid rgba(255,255,255,.15); color: var(--text)}
    .btn.ghost{ background: transparent; border:0; color: var(--muted)}
    .btn.danger{ background: var(--danger)}
    .btn.small{ padding:8px 10px; font-weight:600; font-size:13px }

    .timer{
      display:flex; align-items:center; justify-content:space-between; gap:12px; background:var(--card); border:1px solid rgba(255,255,255,.06);
      padding:16px; border-radius:14px
    }
    .timer-display{ font-variant-numeric: tabular-nums; font-size:28px; font-weight:800 }

    .pill{font-size:12px; padding:6px 10px; border-radius: 999px; background:rgba(59,130,246,.15); color:#cfe1ff; display:inline-block}
    .muted{color: var(--muted)}

    .list{display:flex; flex-direction:column; gap:10px}
    .entry{ background: var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:14px; display:grid; gap:8px}
    .entry-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .entry-meta{font-size:12px; color:var(--muted)}
    .entry-actions{display:flex; gap:8px; flex-wrap:wrap}

    .week{
      display:grid; gap:10px
    }
    .day{
      background: var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px; display:grid; gap:8px
    }
    .bar{
      height:10px; border-radius:999px; background: linear-gradient(90deg, var(--accent), var(--ok)); width:0%
    }
    .day-row{ display:grid; grid-template-columns: 110px 1fr auto; align-items:center; gap:12px }
    .week-nav{ display:flex; align-items:center; justify-content:space-between; gap:12px }

    .footer{ margin-top:18px; font-size:12px; color:var(--muted); text-align:center }
    .danger-zone{ border:1px dashed rgba(239,68,68,.5); padding:12px; border-radius:12px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">TT</div>
        <div>
          <div class="title">Time Tracker</div>
          <div class="muted" id="todaySummary">—</div>
        </div>
      </div>
      <div>
        <button class="btn small" id="exportCsvBtn" title="Download CSV of all logged entries">⬇ Export CSV</button>
      </div>
    </header>

    <div class="grid grid-2">
      <!-- Left: Tracker -->
      <section class="card">
        <h2 style="margin:0 0 12px 0">Track new activity</h2>
        <div class="row">
          <div>
            <label for="activity">Activity name *</label>
            <input id="activity" placeholder="e.g., Write report" />
          </div>
          <div>
            <label for="already">Already spent (HH:MM, optional)</label>
            <input id="already" placeholder="00:00" />
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="desc">Description (optional)</label>
          <textarea id="desc" placeholder="Short notes for context…"></textarea>
        </div>

        <div class="timer" style="margin-top:14px">
          <div>
            <div class="muted" id="status">Ready</div>
            <div class="timer-display" id="display">00:00:00</div>
          </div>
          <div class="entry-actions">
            <button class="btn" id="startBtn">▶ Start timer</button>
            <button class="btn secondary" id="stopBtn" disabled>■ Stop & log</button>
            <button class="btn ghost" id="resetBtn">Reset</button>
          </div>
        </div>
      </section>

      <!-- Right: Week view -->
      <section class="card">
        <div class="week-nav">
          <button class="btn secondary small" id="prevWeekBtn">◀ Previous</button>
          <div>
            <div style="text-align:center; font-weight:800" id="weekLabel">This week</div>
            <div class="muted" style="text-align:center" id="weekTotal">—</div>
          </div>
          <button class="btn secondary small" id="nextWeekBtn">Next ▶</button>
        </div>
        <div class="week" id="weekList" style="margin-top:12px"></div>
      </section>
    </div>

    <!-- Today entries -->
    <section class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px 0">Today's entries</h2>
      <div class="muted" id="todayDate">—</div>
      <div class="list" id="todayList" style="margin-top:12px"></div>
    </section>

    <details class="card" style="margin-top:14px">
      <summary style="cursor:pointer">Advanced • Data backup & reset</summary>
      <div class="row" style="margin-top:10px">
        <div>
          <button class="btn secondary" id="exportJsonBtn">Export JSON (backup)</button>
        </div>
        <div>
          <input type="file" id="importJsonInput" accept="application/json" />
          <button class="btn secondary" id="importJsonBtn">Import JSON</button>
        </div>
      </div>
      <div class="danger-zone" style="margin-top:12px">
        <button class="btn danger" id="clearAllBtn">Delete ALL data (local)</button>
        <div class="muted" style="margin-top:6px">All data is stored locally in your browser (this device only). Export CSV/JSON to move to another device.</div>
      </div>
    </details>

    <div class="footer">Made for GitHub Pages • Data lives in <em>localStorage</em> on your device • No sign‑in, no server.</div>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'tt_entries_v1';
  const CURRENT_KEY = 'tt_current_v1';

  /** ----------------------- Helpers ------------------------ */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function pad(n){ return String(n).padStart(2,'0'); }
  function fmtHMS(totalSec){
    totalSec = Math.max(0, Math.round(totalSec));
    const h = Math.floor(totalSec/3600);
    const m = Math.floor((totalSec%3600)/60);
    const s = totalSec%60;
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  function fmtHM(totalSec){
    totalSec = Math.max(0, Math.round(totalSec));
    const h = Math.floor(totalSec/3600);
    const m = Math.floor((totalSec%3600)/60);
    return `${pad(h)}:${pad(m)}`;
  }
  function hoursDecimal(totalSec){ return Math.round((totalSec/3600)*100)/100; }

  function parseDuration(input){
    if(!input) return 0;
    const str = String(input).trim();
    if(!str) return 0;
    // Accept HH:MM:SS | HH:MM | MM
    const parts = str.split(':').map(x=>x.trim());
    if(parts.some(p=>p==='' || isNaN(p))) return 0;
    let h=0,m=0,s=0;
    if(parts.length===1){ m = parseInt(parts[0],10) || 0; }
    if(parts.length===2){ h=parseInt(parts[0],10)||0; m=parseInt(parts[1],10)||0; }
    if(parts.length===3){ h=parseInt(parts[0],10)||0; m=parseInt(parts[1],10)||0; s=parseInt(parts[2],10)||0; }
    h=Math.max(0,h); m=Math.max(0,m); s=Math.max(0,s);
    return h*3600 + m*60 + s;
  }

  function toYMD(d){
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    return `${y}-${m}-${day}`;
  }
  function startOfDay(d){
    const x = new Date(d); x.setHours(0,0,0,0); return x;
  }
  function startOfWeekMonday(d){
    const x = startOfDay(d);
    const day = x.getDay(); // 0 Sun,1 Mon...
    const diff = (day===0? -6 : 1-day); // shift so Monday is start
    x.setDate(x.getDate()+diff);
    return x;
  }
  function endOfWeekMonday(start){
    const x = new Date(start); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x;
  }
  function prettyDate(d){
    return d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
  }

  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }

  /** ----------------------- Storage ------------------------ */
  function loadEntries(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
    catch(e){ return []; }
  }
  function saveEntries(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
  function loadCurrent(){
    try{ return JSON.parse(localStorage.getItem(CURRENT_KEY)||'null'); }
    catch(e){ return null; }
  }
  function saveCurrent(obj){ if(obj) localStorage.setItem(CURRENT_KEY, JSON.stringify(obj)); else localStorage.removeItem(CURRENT_KEY); }

  /** ----------------------- State ------------------------ */
  let entries = loadEntries();
  let current = loadCurrent();
  let tickHandle = null;
  let currentWeekStart = startOfWeekMonday(new Date());

  /** ----------------------- Elements --------------------- */
  const activityEl = $('#activity');
  const descEl = $('#desc');
  const alreadyEl = $('#already');
  const displayEl = $('#display');
  const statusEl = $('#status');
  const startBtn = $('#startBtn');
  const stopBtn = $('#stopBtn');
  const resetBtn = $('#resetBtn');
  const todaySummaryEl = $('#todaySummary');
  const todayDateEl = $('#todayDate');
  const todayListEl = $('#todayList');
  const weekListEl = $('#weekList');
  const weekLabelEl = $('#weekLabel');
  const weekTotalEl = $('#weekTotal');
  const prevWeekBtn = $('#prevWeekBtn');
  const nextWeekBtn = $('#nextWeekBtn');
  const exportCsvBtn = $('#exportCsvBtn');
  const exportJsonBtn = $('#exportJsonBtn');
  const importJsonBtn = $('#importJsonBtn');
  const importJsonInput = $('#importJsonInput');
  const clearAllBtn = $('#clearAllBtn');

  /** ----------------------- Timer logic ------------------ */
  function updateTimerUI(){
    if(current){
      const base = current.offsetSec || 0;
      const now = Date.now();
      const elapsed = base + (current.running ? Math.floor((now - current.startedAt)/1000) : 0);
      displayEl.textContent = fmtHMS(elapsed);
      statusEl.textContent = current.running ? 'Tracking…' : 'Paused';
      startBtn.disabled = current.running;
      stopBtn.disabled = !current.running;
    }else{
      displayEl.textContent = '00:00:00';
      statusEl.textContent = 'Ready';
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  function tick(){ updateTimerUI(); }

  function startTimer(){
    const name = activityEl.value.trim();
    if(!name){
      alert('Please enter an activity name.');
      activityEl.focus();
      return;
    }
    // build current object if none
    if(!current){
      const offset = parseDuration(alreadyEl.value);
      current = {
        id: uid(),
        activity: name,
        description: descEl.value.trim(),
        offsetSec: offset,
        startedAt: Date.now(),
        running: true,
        createdAt: Date.now()
      };
    }else{
      // resume existing (if paused)
      current.running = true;
      current.startedAt = Date.now();
    }
    saveCurrent(current);
    if(!tickHandle) tickHandle = setInterval(tick, 1000);
    updateTimerUI();
  }

  function stopAndLog(){
    if(!current) return;
    // compute final elapsed
    const base = current.offsetSec || 0;
    const elapsed = base + Math.floor((Date.now() - current.startedAt)/1000);
    const ended = new Date();
    const entry = {
      id: current.id,
      activity: current.activity,
      description: current.description||'',
      seconds: Math.max(0, elapsed),
      date: toYMD(ended),
      startedAt: current.createdAt,
      endedAt: ended.getTime(),
      updatedAt: Date.now()
    };
    // push to entries
    entries.unshift(entry);
    saveEntries(entries);
    // clear current
    current = null; saveCurrent(null);
    clearInterval(tickHandle); tickHandle=null;
    activityEl.value = '';
    descEl.value = '';
    alreadyEl.value = '';
    updateTimerUI();
    renderAll();
  }

  function resetTimer(){
    current = null; saveCurrent(null);
    clearInterval(tickHandle); tickHandle=null;
    updateTimerUI();
  }

  /** ----------------------- Rendering -------------------- */
  function sumSecondsForDate(ymd){
    return entries.filter(e=>e.date===ymd).reduce((a,b)=>a+(b.seconds||0),0);
  }

  function renderToday(){
    const now = new Date();
    const ymd = toYMD(now);
    const total = sumSecondsForDate(ymd);
    todaySummaryEl.textContent = `Today: ${fmtHM(total)} ( ${hoursDecimal(total)} h )`;
    todayDateEl.textContent = now.toLocaleDateString([], {weekday:'long', year:'numeric', month:'long', day:'numeric'});

    const todays = entries.filter(e=>e.date===ymd);
    todayListEl.innerHTML = '';
    if(todays.length===0){
      const p = document.createElement('div'); p.className='muted'; p.textContent='No entries yet today.'; todayListEl.appendChild(p); return;
    }
    todays.forEach(e=> todayListEl.appendChild(entryItem(e)) );
  }

  function entryItem(e){
    const wrap = document.createElement('div'); wrap.className='entry'; wrap.dataset.id = e.id;
    const head = document.createElement('div'); head.className='entry-head';
    const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(e.activity)}</strong>`;
    const actions = document.createElement('div'); actions.className='entry-actions';
    const editBtn = btn('Edit', 'secondary small');
    const delBtn = btn('Delete', 'danger small');
    actions.append(editBtn, delBtn);
    head.append(title, actions);

    const meta = document.createElement('div'); meta.className='entry-meta';
    const when = new Date(e.endedAt||Date.now());
    meta.textContent = `${fmtHM(e.seconds)} • ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

    const desc = document.createElement('div'); desc.className='muted'; desc.textContent = e.description||'';

    const editor = document.createElement('div'); editor.style.display='none'; editor.innerHTML = `
      <div class="row">
        <div>
          <label>Activity</label>
          <input class="edit-activity" value="${escapeAttr(e.activity)}" />
        </div>
        <div>
          <label>Duration (HH:MM)</label>
          <input class="edit-duration" value="${fmtHM(e.seconds)}" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Description</label>
        <textarea class="edit-desc">${escapeHtml(e.description||'')}</textarea>
      </div>
      <div class="entry-actions" style="margin-top:10px">
        <button class="btn small save">Save</button>
        <button class="btn secondary small cancel">Cancel</button>
      </div>
    `;

    editBtn.addEventListener('click', ()=>{ editor.style.display='block'; });
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this entry?')){
        entries = entries.filter(x=>x.id!==e.id); saveEntries(entries); renderAll();
      }
    });

    editor.querySelector('.cancel').addEventListener('click', ()=>{ editor.style.display='none'; });
    editor.querySelector('.save').addEventListener('click', ()=>{
      const newAct = editor.querySelector('.edit-activity').value.trim() || 'Untitled';
      const newDur = parseDuration(editor.querySelector('.edit-duration').value);
      const newDesc = editor.querySelector('.edit-desc').value.trim();
      const idx = entries.findIndex(x=>x.id===e.id);
      if(idx>-1){
        entries[idx] = {...entries[idx], activity:newAct, description:newDesc, seconds: Math.max(0,newDur), updatedAt: Date.now() };
        saveEntries(entries); renderAll();
      }
    });

    wrap.append(head, meta, desc, editor);
    return wrap;
  }

  function btn(text, classes=''){ const b=document.createElement('button'); b.className=`btn ${classes}`; b.textContent=text; return b; }
  function escapeHtml(s=''){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }
  function escapeAttr(s=''){ return s.replace(/"/g,'&quot;'); }

  function renderWeek(){
    // label
    const start = new Date(currentWeekStart);
    const end = endOfWeekMonday(start);
    weekLabelEl.textContent = `${prettyDate(start)} – ${prettyDate(end)}`;

    // compute totals each day
    const days = [];
    let max = 0; let weekTotal = 0;
    for(let i=0;i<7;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const ymd = toYMD(d);
      const total = sumSecondsForDate(ymd);
      days.push({d,total});
      max = Math.max(max,total); weekTotal += total;
    }
    weekTotalEl.textContent = `Total: ${fmtHM(weekTotal)} ( ${hoursDecimal(weekTotal)} h )`;

    weekListEl.innerHTML='';
    days.forEach(({d,total})=>{
      const row = document.createElement('div'); row.className='day day-row';
      const label = document.createElement('div'); label.innerHTML = `<strong>${d.toLocaleDateString([], {weekday:'short'})}</strong><div class="muted">${d.getDate()}/${d.getMonth()+1}</div>`;
      const track = document.createElement('div'); const bar = document.createElement('div'); bar.className='bar';
      const pct = max>0 ? (total/max*100) : 0; bar.style.width = pct.toFixed(1)+'%'; track.appendChild(bar);
      const val = document.createElement('div'); val.innerHTML = `<span class="pill">${fmtHM(total)}</span>`;
      row.append(label, track, val);
      weekListEl.appendChild(row);
    });
  }

  function renderAll(){
    renderToday();
    renderWeek();
  }

  /** ----------------------- CSV / JSON ------------------- */
  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
    a.download = filename; a.style.display='none'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }

  function exportCSV(){
    const header = ['id','date','activity','description','seconds','hhmm','hours_decimal','started_at','ended_at'];
    const rows = entries.slice().reverse().map(e=>[
      e.id,
      e.date,
      wrapCsv(e.activity),
      wrapCsv((e.description||'')),
      e.seconds,
      fmtHM(e.seconds),
      hoursDecimal(e.seconds),
      e.startedAt? new Date(e.startedAt).toISOString() : '',
      e.endedAt? new Date(e.endedAt).toISOString() : ''
    ].join(','));
    const csv = header.join(',') + '\n' + rows.join('\n');
    download('time-tracker.csv', csv);
  }
  function wrapCsv(s){
    const needs = /[",\n]/.test(s);
    return needs ? '"'+s.replace(/"/g,'""')+'"' : s;
  }

  function exportJSON(){
    download('time-tracker-backup.json', JSON.stringify({version:1, entries}, null, 2));
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!data || !Array.isArray(data.entries||data)) throw new Error('Invalid file');
        const list = Array.isArray(data) ? data : data.entries;
        // basic normalisation
        const normalised = list.map(raw=>({
          id: raw.id||uid(),
          activity: String(raw.activity||'Untitled'),
          description: String(raw.description||''),
          seconds: Math.max(0, Number(raw.seconds)||0),
          date: raw.date||toYMD(new Date(raw.endedAt||Date.now())),
          startedAt: raw.startedAt||Date.now(),
          endedAt: raw.endedAt||Date.now(),
          updatedAt: Date.now()
        }));
        entries = normalised.concat(entries); // prepend imported
        saveEntries(entries); renderAll(); alert('Import complete.');
      }catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
  }

  /** ----------------------- Events ----------------------- */
  startBtn.addEventListener('click', startTimer);
  stopBtn.addEventListener('click', stopAndLog);
  resetBtn.addEventListener('click', resetTimer);
  exportCsvBtn.addEventListener('click', exportCSV);
  exportJsonBtn.addEventListener('click', exportJSON);
  importJsonBtn.addEventListener('click', ()=>{
    const f = importJsonInput.files && importJsonInput.files[0];
    if(!f){ alert('Choose a JSON file first.'); return; }
    importJSON(f);
  });
  clearAllBtn.addEventListener('click', ()=>{
    if(confirm('This will delete ALL local data (cannot be undone). Proceed?')){
      entries = []; saveEntries(entries); resetTimer(); renderAll();
    }
  });
  prevWeekBtn.addEventListener('click', ()=>{ currentWeekStart.setDate(currentWeekStart.getDate()-7); renderWeek(); });
  nextWeekBtn.addEventListener('click', ()=>{ currentWeekStart.setDate(currentWeekStart.getDate()+7); renderWeek(); });

  // Restore running state if any
  if(current){ if(current.running){ tickHandle=setInterval(tick,1000);} updateTimerUI();
    // restore form fields so user sees context
    activityEl.value = current.activity||''; descEl.value = current.description||''; alreadyEl.value = fmtHM(current.offsetSec||0);
  } else { updateTimerUI(); }

  renderAll();
})();
</script>
</body>
</html>
